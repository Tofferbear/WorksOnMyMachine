@page "/"
@using Spotoffify.Shared
@using Spotoffify.Client.Services
@using ApexCharts
@inject UiSpotifyService MyService

<PageTitle>Spotoffify - Dashboard</PageTitle>

<div class="container-fluid">
    <div class="row mb-4 mt-3">
        <div class="col-md-8 offset-md-2">

            @if (isReforging)
            {
                <div class="alert alert-dark text-center shadow-sm" role="alert" style="border-radius:12px; height: 152px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div class="spinner-border text-success mb-2" role="status"></div>
                    <div>⚒️ Reforging Tofforgery Tunes...</div>
                </div>
            }
            else
            {
                <iframe style="border-radius:12px"
                        src="@EmbedUrl"
                        width="100%"
                        height="152"
                        frameBorder="0"
                        allowfullscreen=""
                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                        loading="lazy">
                </iframe>
            }

        </div>
    </div>

    <div class="row mb-4">
        <div class="col text-center">
            <h1>🎵 Spotoffify Dashboard</h1>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center mt-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card text-white bg-primary mb-3 shadow-sm h-100">
                    <div class="card-header">Total Commitment</div>
                    <div class="card-body text-center">
                        <h1 class="display-4 fw-bold">@stats.TotalMinutesListened.ToString("N0")</h1>
                        <p class="card-text">Minutes Listened</p>
                        <hr />
                        <h5 class="opacity-75">@stats.TotalPlays Tracks Played</h5>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card bg-dark text-white mb-3 shadow-sm h-100" style="border: 1px solid #333;">
                    <div class="card-header text-success">
                        <i class="bi bi-hourglass-top"></i> Longest Track
                    </div>
                    <div class="card-body d-flex align-items-center">
                        @if (stats.LongestTrack != null)
                        {
                            <img src="@stats.LongestTrack.AlbumImageUrl" class="rounded me-3" style="width: 80px; height: 80px;" />
                            <div>
                                <h5 class="card-title text-truncate" style="max-width: 200px;">@stats.LongestTrack.TrackName</h5>
                                <p class="card-text text-muted mb-0">@stats.LongestTrack.ArtistName</p>
                                <span class="badge bg-secondary">@((stats.LongestTrack.DurationMs / 60000.0).ToString("0.0")) min</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card bg-dark text-white mb-3 shadow-sm h-100" style="border: 1px solid #333;">
                    <div class="card-header text-warning">
                        <i class="bi bi-lightning-charge"></i> Shortest Track
                    </div>
                    <div class="card-body d-flex align-items-center">
                        @if (stats.ShortestTrack != null)
                        {
                            <img src="@stats.ShortestTrack.AlbumImageUrl" class="rounded me-3" style="width: 80px; height: 80px;" />
                            <div>
                                <h5 class="card-title text-truncate" style="max-width: 200px;">@stats.ShortestTrack.TrackName</h5>
                                <p class="card-text text-muted mb-0">@stats.ShortestTrack.ArtistName</p>
                                <span class="badge bg-secondary">@((stats.ShortestTrack.DurationMs / 1000.0).ToString("0")) sec</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-10 offset-md-1">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title">🏆 All-Time Top Artists</h3>
                        <ApexChart TItem="ArtistMetrics"
                                   Options="artistBarOptions"
                                   Height="350">
                            <ApexPointSeries TItem="ArtistMetrics"
                                             Items="artistStats"
                                             Name="Plays"
                                             SeriesType="SeriesType.Bar"
                                             XValue="@(e => e.ArtistName)"
                                             YValue="@(e => e.PlayCount)"
                                             Color="#1DB954" />
                        </ApexChart>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-10 offset-md-1">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title">💿 All-Time Top Tracks</h3>
                        <ApexChart TItem="TrackMetrics"
                                   Options="trackBarOptions"
                                   Height="350">
                            <ApexPointSeries TItem="TrackMetrics"
                                             Items="trackStats"
                                             Name="Plays"
                                             SeriesType="SeriesType.Bar"
                                             XValue="@(e => e.Label)"
                                             YValue="@(e => e.PlayCount)"
                                             Color="#1DB954" />
                        </ApexChart>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-10 offset-md-1">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title">🔥 Listening Habits (UTC)</h3>
                        <p class="text-muted small">Darker = More Music</p>
                        <ApexChart TItem="HeatmapPoint"
                                   Options="heatmapOptions"
                                   Height="400">
                            @foreach (var daySeries in heatmapData)
                            {
                                <ApexPointSeries TItem="HeatmapPoint"
                                                 Items="daySeries.Value"
                                                 Name="@daySeries.Key"
                                                 SeriesType="SeriesType.Heatmap"
                                                 XValue="@(e => e.HourOfDay.ToString("00") + ":00")"
                                                 YValue="@(e => e.PlayCount)" />
                            }
                        </ApexChart>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-10 offset-md-1">
                <h3>Recent Plays</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-dark">
                        <thead>
                            <tr>
                                <th style="width: 80px;">Art</th>
                                <th>Played At</th>
                                <th>Track</th>
                                <th>Artist</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var play in plays)
                            {
                                <tr>
                                    <td>
                                        @if (!string.IsNullOrEmpty(play.AlbumImageUrl))
                                        {
                                            <img src="@play.AlbumImageUrl" alt="Art" class="img-fluid rounded shadow-sm" style="width: 50px; height: 50px; object-fit: cover;" />
                                        }
                                        else
                                        {
                                            <div style="width:50px; height:50px; background-color:#333;" class="rounded d-flex align-items-center justify-content-center">🎵</div>
                                        }
                                    </td>
                                    <td>@play.PlayedAt.ToLocalTime().ToString("g")</td>
                                    <td>@play.TrackName</td>
                                    <td>@play.ArtistName</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;

    // Data Containers
    private DashboardStats stats = new();
    private List<ArtistMetrics> artistStats = new();
    private List<TrackMetrics> trackStats = new();
    private List<TrackedPlay> plays = new();
    private Dictionary<string, List<HeatmapPoint>> heatmapData = new();

    // Chart Configs
    private ApexChartOptions<ArtistMetrics> artistBarOptions = new();
    private ApexChartOptions<TrackMetrics> trackBarOptions = new();
    private ApexChartOptions<HeatmapPoint> heatmapOptions = new();

    // Default to a playlist ID
    private string sourceId = "6Fgo59DtcjJsJpZ5Xzwpkp";
    private string targetId = "2asc455TtftwftvbETI4RG";
    private bool isReforging = true;
    private long forgeTime = DateTime.UtcNow.Ticks;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 1. Kick off 4 requests in parallel!
            var statsTask = MyService.GetDashboardStats();
            var topArtistsTask = MyService.GetTopArtists(10);
            var topTracksTask = MyService.GetTopTracks(10);
            var heatmapTask = MyService.GetHeatmapData();
            var historyTask = MyService.GetMyHistory();

            await Task.WhenAll(statsTask, topArtistsTask, topTracksTask, heatmapTask, historyTask);

            // 2. Assign results
            stats = statsTask.Result;
            artistStats = topArtistsTask.Result;
            trackStats = topTracksTask.Result;
            plays = historyTask.Result;

            // 3. Process Heatmap
            ProcessHeatmapData(heatmapTask.Result);

            ConfigureCharts();

            _ = ReforgeSequence();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ProcessHeatmapData(List<HeatmapPoint> rawPoints)
    {
        string[] days = { "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" };
        heatmapData = new Dictionary<string, List<HeatmapPoint>>();

        for (int d = 6; d >= 0; d--)
        {
            var dayName = days[d];
            var dayPoints = new List<HeatmapPoint>();
            for (int h = 0; h < 24; h++)
            {
                var existing = rawPoints.FirstOrDefault(p => p.DayOfWeek == d && p.HourOfDay == h);
                dayPoints.Add(new HeatmapPoint
                {
                    DayOfWeek = d,
                    HourOfDay = h,
                    PlayCount = existing?.PlayCount ?? 0
                });
            }
            heatmapData.Add(dayName, dayPoints);
        }
    }

    private void ConfigureCharts()
    {
        var theme = new Theme { Mode = Mode.Dark, Palette = PaletteType.Palette1 };

        // Bar Chart
        artistBarOptions.Theme = theme;
        artistBarOptions.PlotOptions = new PlotOptions { Bar = new PlotOptionsBar { Horizontal = true } };
        artistBarOptions.Xaxis = new XAxis { Labels = new XAxisLabels { Style = new AxisLabelStyle { Colors = "#fff" } } };
        artistBarOptions.Yaxis = new List<YAxis> { new YAxis { Labels = new YAxisLabels { Style = new AxisLabelStyle { Colors = "#fff" } } } };

        trackBarOptions.Theme = theme;
        trackBarOptions.PlotOptions = new PlotOptions { Bar = new PlotOptionsBar { Horizontal = true } };
        trackBarOptions.Xaxis = new XAxis { Labels = new XAxisLabels { Style = new AxisLabelStyle { Colors = "#fff" } } };
        trackBarOptions.Yaxis = new List<YAxis> { new YAxis { Labels = new YAxisLabels { Style = new AxisLabelStyle { Colors = "#fff" } } } };

        // Heatmap
        heatmapOptions.Theme = theme;
        heatmapOptions.Xaxis = new XAxis
        {
            Tooltip = new XAxisTooltip { Enabled = false },
            Labels = new XAxisLabels { Style = new AxisLabelStyle { Colors = "#fff" } }
        };
        heatmapOptions.Yaxis = new List<YAxis> { new YAxis { Labels = new YAxisLabels { Style = new AxisLabelStyle { Colors = "#fff" } } } };

        heatmapOptions.PlotOptions = new PlotOptions
        {
            Heatmap = new PlotOptionsHeatmap
            {
                Radius = 2,
                EnableShades = true,
                ColorScale = new PlotOptionsHeatmapColorScale
                {
                    Ranges = new()
                    {
                        new() { From = 0, To = 0, Color = "#121212", Name = "Silent" },
                        new() { From = 1, To = 5, Color = "#0e4d22", Name = "Low" },
                        new() { From = 6, To = 20, Color = "#1DB954", Name = "Medium" },
                        new() { From = 21, To = 500, Color = "#1ed760", Name = "High" }
                    }
                }
            }
        };
    }

    private async Task ReforgeSequence()
    {
        // 4. Do the work
        await ShuffleMyMix();

        await Task.Delay(3000);

        // 5. Update the UI
        isReforging = false;
        forgeTime = DateTime.UtcNow.Ticks; // Update timestamp to bust cache
        StateHasChanged(); // Tell Blazor to re-render only the player section
    }

    private async Task ShuffleMyMix()
    {
        try
        {
            await MyService.ShuffleMix(sourceId, targetId);
            Console.WriteLine("Tofforgery Tunes Reforged! ⚒️");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Failed to shuffle mix: " + ex.Message);
            // Even if it fails, we should show the player (it will just be the old mix)
            isReforging = false;
            StateHasChanged();
        }
    }

    // Helper to generate the URL
    private string EmbedUrl => $"https://open.spotify.com/embed/playlist/{targetId}?utm_source=generator&theme=0&t={forgeTime}";
}
