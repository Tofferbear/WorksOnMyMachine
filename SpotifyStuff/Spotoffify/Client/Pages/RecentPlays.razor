@page "/"
@using Spotoffify.Shared
@using Spotoffify.Client.Services
@using ApexCharts
@inject UiSpotifyService MyService

<PageTitle>Spotoffify - Dashboard</PageTitle>

<div class="container-fluid">
    <div class="row mb-4 mt-3">
        <div class="col-md-8 offset-md-2 text-center">

            @if (isReforging)
            {
                <div class="alert alert-dark shadow-sm d-flex align-items-center justify-content-center" style="border-radius:12px; height: 80px;">
                    <span class="spinner-border text-success me-3" role="status"></span>
                    <span>⚒️ Reforging Tofforgery Tunes...</span>
                </div>
            }
            else
            {
                <div class="p-4 bg-light border rounded-3 shadow-sm">
                    <h4 class="mb-3">Tofforgery Tunes Ready</h4>
                    <a href="spotify:playlist:@targetId" class="btn btn-success btn-lg px-4 gap-2">
                        <i class="bi bi-spotify"></i> Launch in Spotify App
                    </a>
                    <div class="text-muted mt-2 small">
                        (Opens on your PC, Mobile, or Fire TV if installed)
                    </div>
                </div>
            }

        </div>
    </div>

    <div class="row mb-4">
        <div class="col text-center">
            <h1>🎵 Spotoffify Dashboard</h1>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center mt-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="row mb-4 g-3">
            <div class="col-md-4">
                <div class="card bg-dark text-white mb-3 shadow-sm h-100" style="border: 1px solid #333;">
                    <div class="card-header text-success">
                        <i class="bi bi-hourglass-top"></i> Longest Track
                    </div>
                    <div class="card-body d-flex align-items-center">
                        @if (stats.LongestTrack != null)
                        {
                            <img src="@stats.LongestTrack.AlbumImageUrl" class="rounded me-3" style="width: 80px; height: 80px;" />
                            <div>
                                <h5 class="card-title text-truncate" style="max-width: 200px;">@stats.LongestTrack.TrackName</h5>
                                <p class="card-text text-muted mb-0">@stats.LongestTrack.ArtistName</p>
                                <span class="badge bg-secondary">@((stats.LongestTrack.DurationMs / 60000.0).ToString("0.0")) min</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card text-white bg-primary mb-3 shadow-sm h-100">
                    <div class="card-header">Total Commitment</div>
                    <div class="card-body text-center d-flex flex-column justify-content-center">

                        <h1 class="display-5 fw-bold mb-0">
                            @FormatCommitment(stats.TotalMinutesListened)
                        </h1>

                        <p class="card-text text-white-50 small mb-3">Time Spent Listening</p>

                        <div class="border-top border-white border-opacity-25 pt-3 w-100">
                            <div class="row">
                                <div class="col-6 border-end border-white border-opacity-25">
                                    <h5 class="mb-0">@stats.TotalPlays.ToString("N0")</h5>
                                    <small class="text-white-50">Tracks</small>
                                </div>
                                <div class="col-6">
                                    <h5 class="mb-0">@stats.TotalMinutesListened.ToString("N0")</h5>
                                    <small class="text-white-50">Minutes</small>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card bg-dark text-white mb-3 shadow-sm h-100" style="border: 1px solid #333;">
                    <div class="card-header text-warning">
                        <i class="bi bi-lightning-charge"></i> Shortest Track
                    </div>
                    <div class="card-body d-flex align-items-center">
                        @if (stats.ShortestTrack != null)
                        {
                            <img src="@stats.ShortestTrack.AlbumImageUrl" class="rounded me-3" style="width: 80px; height: 80px;" />
                            <div>
                                <h5 class="card-title text-truncate" style="max-width: 200px;">@stats.ShortestTrack.TrackName</h5>
                                <p class="card-text text-muted mb-0">@stats.ShortestTrack.ArtistName</p>
                                <span class="badge bg-secondary">@((stats.ShortestTrack.DurationMs / 1000.0).ToString("0")) sec</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white p-3" role="button" @onclick="() => showCharts = !showCharts">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-bar-chart-line me-2"></i>All-Time Charts
                    </h5>
                    <i class="bi @(showCharts ? "bi-chevron-up" : "bi-chevron-down") text-muted"></i>
                </div>
            </div>

            @if (showCharts)
            {
                <div class="card-body animate__animated animate__fadeIn">
                    <div class="row g-4">

                        <div class="col-md-6">
                            <h6 class="text-center text-muted mb-3">Top Artists</h6>
                            <ApexChart TItem="ArtistMetrics"
                                       Options="artistBarOptions"
                                       Height="350">
                                <ApexPointSeries TItem="ArtistMetrics"
                                                 Items="artistStats"
                                                 Name="Plays"
                                                 SeriesType="SeriesType.Bar"
                                                 XValue="@(e => e.ArtistName)"
                                                 YValue="@(e => e.PlayCount)"
                                                 Color="#1DB954" />
                            </ApexChart>
                        </div>

                        <div class="col-md-6">
                            <h6 class="text-center text-muted mb-3">Top Tracks</h6>
                            <ApexChart TItem="TrackMetrics"
                                       Options="trackBarOptions"
                                       Height="350">
                                <ApexPointSeries TItem="TrackMetrics"
                                                 Items="trackStats"
                                                 Name="Plays"
                                                 SeriesType="SeriesType.Bar"
                                                 XValue="@(e => e.Label)"
                                                 YValue="@(e => e.PlayCount)"
                                                 Color="#1DB954" />
                            </ApexChart>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="row mb-5">
            <div class="col-md-10 offset-md-1">
                <h3>Recent Plays</h3>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th style="min-width: 300px;">Track</th>
                                <th class="d-none d-md-table-cell">Played At</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var play in plays)
                            {
                                <tr>
                                    <td style="padding: 4px 8px;">
                                        <iframe style="border-radius:12px"
                                                src="@($"https://open.spotify.com/embed/track/{play.TrackId}?utm_source=generator&theme=0")"
                                                width="100%"
                                                height="80"
                                                frameBorder="0"
                                                allowfullscreen=""
                                                allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                                                loading="lazy"
                                                scrolling="no">
                                        </iframe>
                                    </td>

                                    <td class="d-none d-md-table-cell text-muted">
                                        @play.PlayedAt.ToLocalTime().ToString("g")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;

    // Data Containers
    private DashboardStats stats = new();
    private List<ArtistMetrics> artistStats = new();
    private List<TrackMetrics> trackStats = new();
    private List<TrackedPlay> plays = new();
    private Dictionary<string, List<HeatmapPoint>> heatmapData = new();

    // Chart Configs
    private ApexChartOptions<ArtistMetrics> artistBarOptions = new();
    private ApexChartOptions<TrackMetrics> trackBarOptions = new();
    private ApexChartOptions<HeatmapPoint> heatmapOptions = new();

    // Default to a playlist ID
    private string sourceId = "6Fgo59DtcjJsJpZ5Xzwpkp";
    private string targetId = "2asc455TtftwftvbETI4RG";
    private bool isReforging = true;
    private long forgeTime = DateTime.UtcNow.Ticks;

    private bool showCharts = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var statsTask = MyService.GetDashboardStats();
            var topArtistsTask = MyService.GetTopArtists(10);
            var topTracksTask = MyService.GetTopTracks(10);
            var heatmapTask = MyService.GetHeatmapData();
            var historyTask = MyService.GetMyHistory();

            await Task.WhenAll(statsTask, topArtistsTask, topTracksTask, heatmapTask, historyTask);

            stats = statsTask.Result;
            artistStats = topArtistsTask.Result;
            trackStats = topTracksTask.Result;
            plays = historyTask.Result;

            ConfigureCharts();

            _ = ReforgeSequence();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ConfigureCharts()
    {
        var theme = new Theme { Mode = Mode.Dark, Palette = PaletteType.Palette1 };

        // Bar Chart
        artistBarOptions.Theme = theme;
        artistBarOptions.PlotOptions = new PlotOptions { Bar = new PlotOptionsBar { Horizontal = true } };
        artistBarOptions.Yaxis = new List<YAxis> { new YAxis { Labels = new YAxisLabels { Style = new AxisLabelStyle { Colors = "#fff" } } } };

        artistBarOptions.Xaxis = new XAxis
        {
            DecimalsInFloat = 0,
            Labels = new XAxisLabels
            {
                Style = new AxisLabelStyle
                {
                    Colors = "#fff"
                },
                Formatter = @"function(val) { return Number(val).toFixed(0); }"
            }
        };

        trackBarOptions.Theme = theme;
        trackBarOptions.PlotOptions = new PlotOptions { Bar = new PlotOptionsBar { Horizontal = true } };
        trackBarOptions.Yaxis = new List<YAxis> { new YAxis { Labels = new YAxisLabels { Style = new AxisLabelStyle { Colors = "#fff" } } } };

        trackBarOptions.Xaxis = new XAxis
        {
            DecimalsInFloat = 0,
            Labels = new XAxisLabels
            {
                Style = new AxisLabelStyle
                {
                    Colors = "#fff"
                },
                Formatter = @"function(val) { return Number(val).toFixed(0); }"
            }
        };
    }

    private async Task ReforgeSequence()
    {
        // 4. Do the work
        await ShuffleMyMix();

        await Task.Delay(3000);

        // 5. Update the UI
        isReforging = false;
        forgeTime = DateTime.UtcNow.Ticks; // Update timestamp to bust cache
        StateHasChanged(); // Tell Blazor to re-render only the player section
    }

    private async Task ShuffleMyMix()
    {
        try
        {
            await MyService.ShuffleMix(sourceId, targetId);
            Console.WriteLine("Tofforgery Tunes Reforged! ⚒️");
        }
        catch (Exception ex)
        {
            Console.WriteLine("Failed to shuffle mix: " + ex.Message);
            // Even if it fails, we should show the player (it will just be the old mix)
            isReforging = false;
            StateHasChanged();
        }
    }

    private string FormatCommitment(double totalMinutes)
    {
        var span = TimeSpan.FromMinutes(totalMinutes);
        var components = new List<string>();

        if (span.Days > 365) components.Add($"{span.Days / 365}y");
        if (span.Days > 0) components.Add($"{span.Days % 365}d");
        if (span.Hours > 0) components.Add($"{span.Hours}h");
        if (span.Minutes > 0) components.Add($"{span.Minutes}m");

        // Join them with spaces (e.g., "3d 4h 20m")
        return string.Join(" ", components);
    }

    // Helper to generate the URL
    private string EmbedUrl => $"https://open.spotify.com/embed/playlist/{targetId}?utm_source=generator&theme=0&t={forgeTime}";
}
